<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.land.modular.file.mapper.FileReceiveInfoMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.land.modular.file.entity.FileReceiveInfo">
        <id column="id" property="id" />
        <result column="receive_user" property="receiveUser" />
        <result column="receive_user_name" property="receiveUserName" />
        <result column="is_read" property="isRead" />
        <result column="update_time" property="updateTime" />
        <result column="is_delete" property="isDelete" />
        <result column="share_id" property="shareId" />
        <result column="create_time" property="createTime" />
        <result column="create_user" property="createUser" />
        <result column="is_reply" property="isReply" />
        <result column="reply_info" property="replyInfo" />
        <result column="reply_time" property="replyTime" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id AS id, receive_user AS receiveUser, receive_user_name AS receiveUserName,
        is_read AS isRead, update_time AS updateTime, is_delete AS isDelete,
        share_id AS shareId, create_time AS createTime, create_user AS createUser,
        is_reply AS isReply, reply_info AS replyInfo, reply_time AS replyTime
    </sql>
    <!--更新删除标识-->
    <update id="updateByShareId">
        update file_receive_info set is_delete='1' where share_id=#{shareId}
    </update>
    <!--删除接受信息-->
    <delete id="deleteByShareId">
        delete from file_receive_info where share_id=#{shareId}
    </delete>
    <select id="selectReceiveList" resultType="java.util.Map">
        select
        t.id as id,
        IF(t.is_read>'0','是','否') as isRead,
        t.create_time as createTime,
        t.create_user as createUser,
        IF(t.is_reply>'0','是','否') as isReply,
        t.reply_info as replyInfo,
        t1.share_title as shareTitle,
        t1.remark as remark
        from file_receive_info t
        left join file_share_info t1 on t.share_id=t1.share_id
        where t.is_delete != '1'
        <if test="shareTitle != null and shareTitle != ''">
            and t1.share_title like CONCAT('%',#{shareTitle},'%')
        </if>
        <if test="userId != null and userId != ''">
            and t.receive_user = #{userId}
        </if>
        <!--
        <if test="deptId != null and deptId != 0">
            and (dept_id = #{deptId} or dept_id in ( select dept_id from sys_dept where pids like CONCAT('%$[', #{deptId}, '$]%') escape '$' ))
        </if>-->
        <if test="beginTime != null and beginTime != '' and endTime != null and endTime != ''">
            and (t.create_time between CONCAT(#{beginTime},' 00:00:00') and CONCAT(#{endTime},' 23:59:59'))
        </if>
    </select>
    <!---->
    <select id="getListByShareId" resultType="com.land.modular.file.entity.FileReceiveInfo">
        select
        <include refid="Base_Column_List"/>
        from file_receive_info
        where share_id = #{shareId}
        order by reply_time asc
    </select>
    <!---->
    <select id="getNewFileNum" resultType="java.lang.Integer">
        select count(*) from file_receive_info where receive_user = #{userId} and is_reply='0'
    </select>
    <!---->
    <select id="getReciveFileStatistics" resultType="java.util.Map">
        select date_format(create_time, '%Y-%m') as yearMonth,count(1) as fileNum
        from tudi_oa.file_receive_info
        where receive_user = #{userId} and create_time > DATE_SUB(CURDATE(),INTERVAL dayofyear(now())-1 DAY)
        group by date_format(create_time, '%Y-%m')
    </select>
    <!---->
    <select id="getSendFileStatistics" resultType="java.util.Map">
        select receive_user_name,count(1) as fileNum  from tudi_oa.file_receive_info
        where share_id in (select share_id from tudi_oa.file_share_info where create_user = #{userId})
        group by receive_user_name
    </select>

</mapper>